
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>CatBot PWA</title>
<style>
:root{
  --wa-green:#075e54;
  --bg:#ece5dd;
  --me:#dcf8c6;
  --other:#fff;
}

/* ===== Body & Header ===== */
body {
  margin:0;
  font-family: Segoe UI;
  background: var(--bg);
  font-size: 15px;
}
header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  background: var(--wa-green);
  color:#fff;
  padding:10px 12px;
  position:sticky;
  top:0;
  z-index:10;
}
.left { display:flex; align-items:center; gap:10px }
header img { width:40px; height:40px; border-radius:50% }
.title { line-height:1 }
.title b { display:block; font-size:16px }
.title small { opacity:.8 }
.actions { display:flex; align-items:center; gap:8px }
.chip {
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  background:#ffffff26;
  cursor:pointer;
  user-select:none;
}
.fab { background:none; border:none; color:#fff; font-size:22px; cursor:pointer }

/* ===== Chat ===== */
#chat {
  padding:12px;
  min-height: calc(100vh - 120px);
  display:flex;
  flex-direction:column;
  gap:8px;
  position:relative;
}
.msg {
  max-width:78%;
  padding:10px 12px;
  border-radius:10px;
  box-shadow:0 1px 1px #0001;
  word-wrap:break-word;
  position:relative;
}


/* Bubble jawaban bot */
.msg.bot {
  display: inline-block;             /* biar mengikuti lebar teks */
  max-width: 78%;                    /* maksimal 78% layar */
  padding: 10px 14px;
  border-radius: 10px;
  background: var(--other);
  font-size: 19px;
  line-height: 1.4;
  word-wrap: break-word;             /* biar teks panjang wrap */
}

/* Bubble jawaban user */
.msg.user {
  display: inline-block;
  max-width: 78%;
  padding: 10px 14px;
  border-radius: 10px;
  background: var(--me);
  font-size: 16px;
  line-height: 1.4;
  word-wrap: break-word;
}

.meta { margin-top:4px; font-size:11px; opacity:.65; text-align:right }


.copyBtn {
  position: absolute;
  top: 4px;
  right: 4px;
  background: none;
  border: none;
  font-size: 14px;
  cursor: pointer;
  opacity: 0;
  transition: opacity .2s;
}
.msg:hover .copyBtn { opacity:0.7 }
.msg:hover .copyBtn:hover { opacity:1 }

/* ===== Footer ===== */
footer {
  position:sticky;
  bottom:0;
  background:#fff;
  border-top:1px solid #0001;
  padding:10px;
}
.row { display:flex; gap:8px; align-items:center }
#prompt {
  flex:1;
  resize:none;
  height:42px;
  padding:10px;
  border:1px solid #0002;
  border-radius:22px;
  font-size:20px;
}
.send {
  background:var(--wa-green);
  color:#fff;
  border:none;
  border-radius:50%;
  width:42px; height:42px;
  cursor:pointer;
}
.clear {
  background:#eee;
  border:none;
  border-radius:50px;
  padding:0 12px;
  font-size:13px;
  cursor:pointer;
}
/* ===== Popup Global ===== */
#popup {
  display: none;
  position: fixed;
  top: 10px;
  right: 10px;
  width: min(92vw, 420px);
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  z-index: 100; /* lebih tinggi dari mediaPopup */
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
}
#popup.active { display:block }
.closeX {
  position: absolute;
  top: 8px;
  right: 8px;
  background:none;
  border:none;
  font-size:18px;
  cursor:pointer;
  z-index:110;
}

/* Popup Media */
#mediaPopup {
  display:none;
  position: fixed;
  bottom: 20px;
  left:50%;
  transform:translateX(-50%);
  width:min(92vw,360px);
  background:#fff;
  border-radius:12px;
  padding:12px;
  z-index:90;
  box-shadow: 0 8px 20px rgba(0,0,0,.3);
}
#mediaPopup.active { display:block }
.closePopup {
  position:absolute;
  top:6px;
  right:6px;
  background:#ddd;
  border:none;
  border-radius:50%;
  width:28px; height:28px;
  cursor:pointer;
  font-size:16px;
  z-index:95;
}

.popupContent {
  background:#fff;
  padding:16px;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width:200px;
}
.mediaBtn {
  padding:10px;
  border-radius:8px;
  background:#eee;
  text-align:center;
  cursor:pointer;
}
.closePopup {
  margin-top:8px;
  padding:6px;
  border:none;
  background:#ddd;
  border-radius:8px;
  cursor:pointer;
}

/* ===== Popup API / Settings ===== */
#popup .card { background:#fff; padding:16px; border-radius:12px; width:min(92vw,420px); position:relative }
#popup h3 { margin:0 0 10px }
.grid { display:grid; grid-template-columns:1fr 1fr; gap:10px }
.grid .col-2 { grid-column:1/-1 }
label { font-size:12px; opacity:.85 }
input, select { width:100%; padding:8px; border:1px solid #0002; border-radius:8px; margin-top:4px }
.closeX { position:absolute; right:10px; top:10px; background:none; border:none; font-size:18px; cursor:pointer }
.note { font-size:12px; opacity:.8; margin:6px 0 10px }
.btnRow { display:flex; gap:8px; margin-top:10px }
.btn { flex:1; padding:10px; border:none; border-radius:8px; cursor:pointer }
.primary { background:var(--wa-green); color:#fff }
.danger { background:#eee }
</style>
</head>

<body>

<!-- ===== Header ===== -->
<header>
  <div class="left">
    <img src="https://i.pravatar.cc/100?img=47" alt="cewe">
    <div class="title">
      <b>CatBot</b>
      <small id="status">online</small>
    </div>
  </div>
  <div class="actions">
    <span id="providerBadge" class="chip" title="Klik untuk ganti provider">Gemini</span>
    <button id="openPopup" class="fab" title="API Keys">+</button>
  </div>
</header>

<!-- ===== Chat ===== -->
<main id="chat"></main>

<!-- ===== Footer ===== -->
<footer>
  <div class="row">
    <button id="btnClear" class="clear">=</button>
    <textarea id="prompt" placeholder="Tulis pesan‚Ä¶"></textarea>
    <button id="btnSend" class="send">‚û§</button>
  </div>
</footer>

<!-- ===== Popup Media / Clear ===== -->
<div id="mediaPopup" class="popup">
  <div class="popupContent">
    <div class="mediaBtn" id="btnCamera">üì∑ Kamera</div>
    <div class="mediaBtn" id="btnPhoto">üñºÔ∏è Foto</div>
    <div class="mediaBtn" id="btnFile">üìé File</div>
    <div class="mediaBtn" id="btnClearChat">üßπ Bersihkan Chat</div>
    <button class="closePopup">‚úï</button>
  </div>
</div>

<!-- ===== Popup API / Settings ===== -->
<div id="popup" aria-hidden="true">
  <div class="card" role="dialog" aria-modal="true" aria-labelledby="ttl">
    <button id="closePopup" class="closeX">‚úï</button>
    <h3 id="ttl">Pengaturan & API Keys</h3>
    <p class="note">Kunci disimpan lokal di <code>localStorage</code>. Untuk produksi, gunakan server proxy agar key tidak terekspos.</p>
    <div class="grid">
      <div class="col-2">
        <label for="providerSel">Provider aktif</label>
        <select id="providerSel">
          <option value="gemini">Gemini</option>
          <option value="openai">OpenAI</option>
        </select>
      </div>
      <div class="col-2">
        <label for="systemPrompt">System prompt (opsional)</label>
        <input id="systemPrompt" placeholder="mis: jawab singkat, bahasa Indonesia">
      </div>
      <div class="col-2" style="margin-top:6px"><b>üî∑ Gemini</b></div>
      <div class="col-2">
        <label for="geminiKey">Gemini API Key</label>
        <input id="geminiKey" type="password" placeholder="AI...">
      </div>
      <div>
        <label for="geminiModel">Model</label>
        <select id="geminiModel">
          <option value="gemini-1.5-flash">gemini-1.5-flash</option>
          <option value="gemini-1.5-pro">gemini-1.5-pro</option>
        </select>
      </div>
      <div>
        <label for="gemTemp">Temperature</label>
        <input id="gemTemp" type="number" step="0.1" min="0" max="2" value="1">
      </div>
      <div class="col-2" style="margin-top:6px"><b>üü£ OpenAI</b></div>
      <div class="col-2">

 <label for="openaiKey">OpenAI API Key</label>
        <input id="openaiKey" type="password" placeholder="sk-...">
      </div>
      <div>
        <label for="openaiModel">Model</label>
        <select id="openaiModel">
          <option value="gpt-4o-mini">gpt-4o-mini</option>
          <option value="gpt-4o">gpt-4o</option>
          <option value="gpt-4.1-mini">gpt-4.1-mini</option>
        </select>
      </div>
      <div>
        <label for="oaTemp">Temperature</label>
        <input id="oaTemp" type="number" step="0.1" min="0" max="2" value="1">
      </div>
    </div>
    <div class="btnRow">
      <button id="btnSave" class="btn primary">Simpan</button>
      <button id="btnWipe" class="btn danger">Hapus Lokal</button>
    </div>
  </div>
</div>

<!-- ===== Script ===== -->
<script>

const $ = s => document.querySelector(s);
const chatEl = $('#chat'), promptEl = $('#prompt');

// ===== State =====
const state = {
  provider: 'gemini',
  system: '',
  history: [],
  gemini: { key:'', model:'gemini-1.5-flash', temperature: 1 },
  openai: { key:'', model:'gpt-4o-mini', temperature: 1 },
};

// ===== Local Storage =====
function saveLocal(){
  localStorage.setItem('catbot_settings', JSON.stringify({
    provider: state.provider,
    system: state.system,
    gemini: state.gemini,
    openai: state.openai
  }));
  updateBadges();
}

function loadLocal(){
  const raw = localStorage.getItem('catbot_settings');
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    state.provider = s.provider ?? state.provider;
    state.system = s.system ?? '';
    state.gemini = Object.assign(state.gemini, s.gemini||{});
    state.openai = Object.assign(state.openai, s.openai||{});
  }catch(e){}
  $('#providerSel').value = state.provider;
  $('#systemPrompt').value = state.system || '';
  $('#geminiKey').value = state.gemini.key || '';
  $('#geminiModel').value = state.gemini.model || 'gemini-1.5-flash';
  $('#gemTemp').value = state.gemini.temperature ?? 1;
  $('#openaiKey').value = state.openai.key || '';
  $('#openaiModel').value = state.openai.model || 'gpt-4o-mini';
  $('#oaTemp').value = state.openai.temperature ?? 1;
  updateBadges();
}

function updateBadges(){
  $('#providerBadge').textContent = state.provider==='gemini'?'Gemini':'OpenAI';
  $('#status').textContent = 'online';
}

// ===== Popup Toggle =====
const popup = $('#popup');
$('#openPopup').onclick = () => popup.classList.add('active');
$('#closePopup').onclick = () => popup.classList.remove('active');
popup.addEventListener('click', e => { if(e.target===popup) popup.classList.remove('active'); });

const mediaPopup = $('#mediaPopup');
$('#btnClear').onclick = () => mediaPopup.classList.add('active');
document.querySelectorAll('.closePopup').forEach(btn => btn.onclick = () => mediaPopup.classList.remove('active'));
mediaPopup.addEventListener('click', e => { if(e.target===mediaPopup) mediaPopup.classList.remove('active'); });

// ===== Save / Wipe =====
$('#btnSave').onclick = () => {
  state.provider = $('#providerSel').value;
  state.system = $('#systemPrompt').value.trim();
  state.gemini.key = $('#geminiKey').value.trim();
  state.gemini.model = $('#geminiModel').value;
  state.gemini.temperature = parseFloat($('#gemTemp').value)||1;
  state.openai.key = $('#openaiKey').value.trim();
  state.openai.model = $('#openaiModel').value;
  state.openai.temperature = parseFloat($('#oaTemp').value)||1;

  if(state.provider==='openai' && !state.openai.key){
    return toast('‚ùå OpenAI API key kosong!');
  }
  if(state.provider==='gemini' && !state.gemini.key){
    return toast('‚ùå Gemini API key kosong!');
  }

  saveLocal();
  toast('Disimpan ‚úÖ');
  popup.classList.remove('active');
};

$('#btnWipe').onclick = () => {
  if(!confirm('Hapus semua setelan lokal?')) return;
  localStorage.removeItem('catbot_settings');
  location.reload();
};

// ===== Provider Toggle =====
$('#providerBadge').onclick = () => {
  state.provider = (state.provider==='gemini'?'openai':'gemini');
  saveLocal();
  toast('Provider: '+(state.provider==='gemini'?'Gemini':'OpenAI'));
};

// ===== Chat Functions =====
function addMsg(role, content, type='text'){
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + (role==='user'?'user':'bot');

  if(type === 'text') wrap.innerHTML = content;
  else if(type === 'image'){
    const img = document.createElement('img');
    img.src = content;
    img.className = 'preview';
    wrap.appendChild(img);
  }
  else if(type === 'file'){
    const a = document.createElement('a');
    a.href = content;
    a.textContent = content.split('/').pop(); 
    a.target = '_blank';
    a.className = 'fileLink';
    wrap.appendChild(a);
  }

  const copyBtn = document.createElement('button');
  copyBtn.className = 'copyBtn';
  copyBtn.textContent = 'üìã';
  copyBtn.onclick = ()=> { if(type==='text') navigator.clipboard.writeText(content); else alert('Hanya teks bisa dicopy'); };
  wrap.appendChild(copyBtn);

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  wrap.appendChild(meta);

  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function escapeHtml(s){return (s+'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

// ===== Event Listeners =====
$('#btnSend').onclick = onSubmit;
promptEl.addEventListener('keydown', e => { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); onSubmit(); } });
$('#btnClearChat').onclick = () => { chatEl.innerHTML=''; state.history=[]; mediaPopup.classList.remove('active'); };

// ===== AI Call =====
async function onSubmit(){
  const text = promptEl.value.trim();
  if(!text) return;
  promptEl.value = '';
  addMsg('user', text);
  state.history.push({role:'user', content:text});
  addMsg('assistant', '‚è≥ sedang mengetik...');

  try{
    let reply;
    if(state.provider==='gemini'){
      if(!state.gemini.key) throw new Error('Gemini API key kosong!');
      reply = await callGemini(text);
    } else {
      if(!state.openai.key) throw new Error('OpenAI API key kosong!');
      reply = await callOpenAI(text);
    }
    chatEl.removeChild(chatEl.lastElementChild);
    addMsg('assistant', reply);
    state.history.push({role:'assistant', content:reply});
  }catch(err){
    chatEl.removeChild(chatEl.lastElementChild);
    addMsg('assistant', '‚ùå '+(err?.message||err));
  }
}

// ===== Gemini API =====
async function callGemini(prompt){
  const {key, model, temperature} = state.gemini;
  const tail = state.history.slice(-8).map(m=>({ role: m.role==='assistant'?'model':'user', parts:[{text:m.content}] }));
  const body = { contents: tail.concat([{role:'user', parts:[{text:prompt}]}]), generationConfig:{temperature} };
  if(state.system) body.systemInstruction={role:'user', parts:[{text: state.system}]};
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent?key=${encodeURIComponent(key)}`;
  const res = await fetch(url,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
  const data = await res.json();
  if(!res.ok) throw new Error(data?.error?.message || `Gemini ${res.status}`);
  return data?.candidates?.[0]?.content?.parts?.map(p=>p.text).join('')?.trim() || '(kosong)';
}

// ===== OpenAI API =====
async function callOpenAI(prompt){
  const {key, model, temperature} = state.openai;
  const msgs = [];
  if(state.system) msgs.push({role:'system', content:state.system});
  for(const m of state.history.slice(-12)) msgs.push({role:m.role, content:m.content});
  msgs.push({role:'user', content:prompt});
  const res = await fetch('https://api.openai.com/v1/chat/completions',{
    method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
    body:JSON.stringify({ model, messages: msgs, temperature })
  });
  const data = await res.json();
  if(!res.ok) throw new Error(data?.error?.message || `OpenAI ${res.status}`);
  return (data?.choices?.[0]?.message?.content || '').trim() || '(kosong)';
}

// ===== Toast =====
function toast(txt){
  const el = document.createElement('div');
  el.textContent = txt;
  el.style.cssText = 'position:fixed;left:50%;bottom:84px;transform:translateX(-50%);background:#0b2a3a;color:#c9eaff;border:1px solid #124a63;padding:10px 14px;border-radius:10px;z-index:60;box-shadow:0 10px 30px rgba(0,0,0,.4);font-size:13px';
  document.body.appendChild(el); 
  setTimeout(()=>el.remove(),1500);
}

// ===== Media Handler =====
function handleFileInput(accept, capture=false, type='file'){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = accept;
  if(capture) input.capture = 'environment';

  input.onchange = () => {
    const file = input.files[0];
    if(!file) return;
    const url = URL.createObjectURL(file);
    addMsg('user', url, type);
    sendToAI(file, type);
  }
  input.click();
}

document.getElementById('btnCamera').onclick = () => handleFileInput('image/*', true, 'image');
document.getElementById('btnPhoto').onclick = () => handleFileInput('image/*', false, 'image');
document.getElementById('btnFile').onclick = () => handleFileInput('*/*', false, 'file');

async function sendToAI(file, type){
  // contoh endpoint backend
  const formData = new FormData();
  formData.append('file', file);
  formData.append('type', type);
  try{
    const res = await fetch('/api/upload', { method:'POST', body: formData });
    const data = await res.json();
    addMsg('assistant', data.reply);
  }catch(e){
    addMsg('assistant', '‚ùå Gagal kirim file ke AI');
  }
}

// ===== Init =====
loadLocal();

</script>                   
</body>                     </html>
