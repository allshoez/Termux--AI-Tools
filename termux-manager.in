#!/data/data/com.termux/files/usr/bin/env bash
# Termux Manager Pro Style - Fuzzy Scan Lengkap + Buka Isi File + Warna

TRASH="$HOME/trash"
mkdir -p "$TRASH"

# ===== Warna =====
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # no color

pause() { read -p "⏎ Tekan ENTER untuk kembali..."; }
clear_screen() { clear; }

spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
    while ps -p $pid > /dev/null 2>&1; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "      \b\b\b\b\b\b"
}

# ===== Folder/File Basic =====
list_folder() {
    local path="$1"
    [ ! -d "$path" ] && { echo -e "${RED}[!] Folder $path tidak ditemukan${NC}"; return; }
    echo -e "${CYAN}📂 Isi folder: $path${NC}"
    shopt -s nullglob
    local files=("$path"/*)
    [ ${#files[@]} -eq 0 ] && echo -e "${YELLOW}[kosong]${NC}" || for f in "${files[@]}"; do
        [ -d "$f" ] && echo -e "${BLUE}📁 $(basename "$f")${NC}" || echo -e "${GREEN}📄 $(basename "$f")${NC}"
    done
    shopt -u nullglob
}

create_folder() { read -p "📂 Nama folder baru: " name; [ -z "$name" ] && return; mkdir -p "$1/$name"; echo -e "${GREEN}[✔] Folder $name dibuat!${NC}"; }
create_file() { read -p "📄 Nama file baru: " name; [ -z "$name" ] && return; touch "$1/$name"; echo -e "${GREEN}[✔] File $name dibuat!${NC}"; }

rename_folder_file() { list_folder "$1"; read -p "✏️ Nama lama: " old; read -p "✏️ Nama baru: " new; [ -e "$1/$old" ] && mv "$1/$old" "$1/$new" && echo -e "${GREEN}[✔] $old → $new${NC}" || echo -e "${RED}[!] Tidak ditemukan${NC}"; pause; }

delete_folder_soft() { list_folder "$1"; read -p "🗑️ Folder ke trash: " target; [ ! -d "$1/$target" ] && return; mv "$1/$target" "$TRASH/${target}_$(date +%s)" & spinner $!; echo -e "${GREEN}[✔] Dipindahkan ke trash${NC}"; pause; }
delete_folder_permanen() { list_folder "$1"; read -p "⚠️ Folder hapus permanen: " target; [ ! -d "$1/$target" ] && return; rm -rf "$1/$target" & spinner $!; echo -e "${GREEN}[✔] Dihapus permanen${NC}"; pause; }
delete_file_soft() { list_folder "$1"; read -p "🗑️ File ke trash: " target; [ ! -f "$1/$target" ] && return; mv "$1/$target" "$TRASH/${target}_$(date +%s)" & spinner $!; echo -e "${GREEN}[✔] Dipindahkan ke trash${NC}"; pause; }
delete_file_permanen() { list_folder "$1"; read -p "⚠️ File hapus permanen: " target; [ ! -f "$1/$target" ] && return; rm -f "$1/$target" & spinner $!; echo -e "${GREEN}[✔] Dihapus permanen${NC}"; pause; }

# ===== Fuzzy Search Interaktif + Buka Isi File =====
search_file_fuzzy_interactive() {
    local path="$1"
    shopt -s globstar nullglob
    local all_files=("$path"/**/*)
    shopt -u globstar nullglob

    if [ ${#all_files[@]} -eq 0 ]; then
        echo -e "${RED}[!] Folder kosong atau tidak ada file${NC}"
        pause
        return
    fi

    read -p "🔍 Masukkan keyword pencarian (X untuk batal): " keyword
    [[ -z "$keyword" || "$keyword" =~ ^[Xx]$ ]] && return

    local results=()
    for f in "${all_files[@]}"; do
        [[ $(basename "$f") =~ $keyword ]] && results+=("$f")
    done

    if [ ${#results[@]} -eq 0 ]; then
        echo -e "${RED}[!] Tidak ditemukan file/folder untuk '$keyword'${NC}"
        pause
        return
    fi

    echo -e "${MAGENTA}📄 Hasil pencarian:${NC}"
    local i=1
    for f in "${results[@]}"; do
        if [ -d "$f" ]; then
            echo -e "${BLUE}$i) $f${NC}"
        else
            echo -e "${GREEN}$i) $f${NC}"
        fi
        ((i++))
    done

    read -p "➡️ Pilih nomor file/folder untuk aksi (X untuk batal): " choice
    [[ "$choice" =~ ^[Xx]$ ]] && return
    local target="${results[$((choice-1))]}"
    [ -z "$target" ] && return

    echo -e "🔹 Pilihan: ${CYAN}$target${NC}"
    echo "1. Buka folder"
    echo "2. Buka isi file teks"
    echo "3. Rename"
    echo "4. Hapus permanen"
    echo "5. Pindahkan ke trash"
    echo "X. Batal"
    read -p "➡️ Pilih aksi: " action
    case "$action" in
        1) [ -d "$target" ] && cd "$target" && echo -e "${GREEN}[✔] Masuk folder $target${NC}" || echo -e "${RED}[!] Bukan folder${NC}"; pause ;;
        2) [ -f "$target" ] && { echo -e "${YELLOW}===== Isi File =====${NC}"; cat "$target"; echo -e "${YELLOW}==================${NC}"; } || echo -e "${RED}[!] Bukan file${NC}"; pause ;;
        3) read -p "✏️ Nama baru: " newname; [ -n "$newname" ] && mv "$target" "$(dirname "$target")/$newname" && echo -e "${GREEN}[✔] Rename berhasil${NC}"; pause ;;
        4) rm -rf "$target" & spinner $!; echo -e "${GREEN}[✔] Dihapus permanen${NC}"; pause ;;
        5) mv "$target" "$TRASH/$(basename "$target")_$(date +%s)" & spinner $!; echo -e "${GREEN}[✔] Dipindahkan ke trash${NC}"; pause ;;
        X|x) return ;;
    esac
}

# ===== Manager Area =====
manager_area() {
    local path="$1"; local name="$2"
    while true; do
        clear_screen
        echo -e "${CYAN}🖥️ === $name ===${NC}"
        echo "1. Lihat isi folder"
        echo "2. Rename/Edit folder/file"
        echo "3. Hapus folder permanen"
        echo "4. Hapus folder ke trash"
        echo "5. Hapus file permanen"
        echo "6. Hapus file ke trash"
        echo "7. Buat folder baru"
        echo "8. Buat file baru"
        echo "9. Cari file/folder fuzzy + buka isi"
        echo "X. Kembali"
        read -p "➡️ Pilih opsi: " opt
        case "$opt" in
            1) list_folder "$path"; pause;;
            2) rename_folder_file "$path";;
            3) delete_folder_permanen "$path";;
            4) delete_folder_soft "$path";;
            5) delete_file_permanen "$path";;
            6) delete_file_soft "$path";;
            7) create_folder "$path"; pause;;
            8) create_file "$path"; pause;;
            9) search_file_fuzzy_interactive "$path";;
            X|x) break;;
        esac
    done
}

# ===== Main Menu =====
while true; do
    clear_screen
    echo -e "${MAGENTA}🗂️ === TERMUX MANAGER PRO STYLE ===${NC}"
    echo "1. Kelola Home Termux (~)"
    echo "2. Kelola SDCard (/sdcard)"
    echo "X. Keluar"
    read -p "➡️ Pilih menu: " opt
    case "$opt" in
        1) manager_area "$HOME" "HOME TERMUX (~)" ;;
        2) manager_area "/sdcard" "STORAGE HP (/sdcard)" ;;
        X|x) echo -e "${GREEN}[✔] Terima kasih sudah menggunakan Termux Manager Pro!${NC}"; break ;;
    esac
done
