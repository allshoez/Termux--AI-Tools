#!/data/data/com.termux/files/usr/bin/env bash
# manager.in - Termux File Manager Installer Style (Full Version)

TRASH="$HOME/trash"
mkdir -p "$TRASH"

pause() {
    read -p $'\033[1;33mTekan ENTER untuk kembali...\033[0m'
}

clear_screen() { clear; }

spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
    while ps -p $pid > /dev/null 2>&1; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "      \b\b\b\b\b\b"
}

list_folder() {
    local path="$1"
    [ ! -d "$path" ] && { echo -e "\033[1;31m[!] Folder $path tidak ditemukan!\033[0m"; return; }
    echo -e "\033[1;36m📂 Isi folder: $path\033[0m"
    for f in "$path"/*; do
        if [ -d "$f" ]; then
            echo -e "\033[1;33m[DIR] $(basename "$f")\033[0m"
        else
            echo -e "      \033[1;32m$(basename "$f")\033[0m"
        fi
    done
}

create_folder() {
    read -p $'\033[1;36mNama folder baru: \033[0m' name
    [ -z "$name" ] && { echo -e "\033[1;31m[!] Nama kosong!\033[0m"; return; }
    mkdir -p "$1/$name"
    echo -e "\033[1;32m[✔] Folder $name dibuat!\033[0m"
}

rename_folder() {
    list_folder "$1"
    read -p $'\033[1;36mNama lama: \033[0m' old
    read -p $'\033[1;36mNama baru: \033[0m' new
    [ -e "$1/$old" ] && mv "$1/$old" "$1/$new" && echo -e "\033[1;32m[✔] $old → $new\033[0m" || echo -e "\033[1;31m[!] Tidak ditemukan!\033[0m"
}

delete_folder_animated() {
    list_folder "$1"
    read -p $'\033[1;31mHapus folder/file: \033[0m' target
    [ ! -e "$1/$target" ] && { echo "[!] Tidak ditemukan"; pause; return; }
    read -p "Yakin hapus? (y/n): " confirm
    [ "$confirm" != "y" ] && { echo "[Batal]"; pause; return; }
    mv "$1/$target" "$TRASH/${target}_$(date +%s)" &
    spinner $!
    echo -e "\033[1;32m[✔] Dipindahkan ke trash\033[0m"
    pause
}

explore_folder() {
    local path="$1"
    while true; do
        clear_screen
        echo -e "\033[1;34m=== EXPLORER: $path ===\033[0m"
        echo "1. Lihat isi folder (rekursif)"
        echo "2. Rename/Edit folder/file"
        echo "3. Hapus folder/file"
        echo "X. Kembali"
        read -p $'\033[1;36mPilih opsi: \033[0m' opt
        case "$opt" in
            1) find "$path" -print | sed "s|$path|.|" | awk '{print "\033[1;32m" $0 "\033[0m"}'; pause;;
            2) rename_folder "$path"; pause;;
            3) delete_folder_animated "$path"; pause;;
            X|x) break;;
        esac
    done
}

home_manager() {
    local path="$HOME"
    while true; do
        clear_screen
        echo -e "\033[1;34m=== HOME TERMUX (~) ===\033[0m"
        echo "A. Lihat isi folder"
        echo "B. Rename/Edit folder"
        echo "C. Hapus folder"
        echo "D. Buat folder baru"
        echo "E. Restore folder dari trash"
        echo "X. Kembali"
        read -p $'\033[1;36mPilih opsi: \033[0m' opt
        case "$opt" in
            A|a)
                list_folder "$path"
                read -p "Folder untuk eksplor: " sel
                [ -d "$path/$sel" ] && explore_folder "$path/$sel" || echo "[!] Tidak ditemukan"
                pause
                ;;
            B|b) rename_folder "$path"; pause;;
            C|c) delete_folder_animated "$path"; pause;;
            D|d) create_folder "$path"; pause;;
            E|e) restore_folder_progress; pause;;
            X|x) break;;
        esac
    done
}

sdcard_manager() {
    local path="/sdcard"
    while true; do
        clear_screen
        echo -e "\033[1;35m=== STORAGE HP (/sdcard) ===\033[0m"
        echo "A. Lihat isi folder"
        echo "B. Salin folder ke Home"
        echo "C. Rename/Edit folder/file di SDCard"
        echo "D. Buat folder baru di SDCard"
        echo "X. Kembali"
        read -p $'\033[1;36mPilih opsi: \033[0m' opt
        case "$opt" in
            A|a)
                list_folder "$path"
                read -p "Folder untuk eksplor: " sel
                [ -d "$path/$sel" ] && explore_folder "$path/$sel" || echo "[!] Tidak ditemukan"
                pause
                ;;
            B|b)
                list_folder "$path"
                read -p "Nama folder untuk disalin: " folder
                src="$path/$folder"
                dst="$HOME/$folder"
                [ -d "$src" ] || { echo "[!] Tidak ditemukan"; pause; continue; }
                [ -d "$dst" ] && { read -p "Timpa? (y/n): " ow; [ "$ow" != "y" ] && continue; rm -rf "$dst"; }
                cp -r "$src" "$dst" &
                spinner $!
                echo -e "\033[1;32m[✔] Folder berhasil disalin ke Home\033[0m"
                pause
                ;;
            C|c) rename_folder "$path"; pause;;
            D|d) create_folder "$path"; pause;;
            X|x) break;;
        esac
    done
}

restore_folder_progress() {
    if [ ! "$(ls -A $TRASH)" ]; then echo -e "\033[1;33m[!] Trash kosong\033[0m"; pause; return; fi
    echo -e "\033[1;36m📂 Trash:\033[0m"
    select f in "$TRASH"/*; do
        [ -n "$f" ] || continue
        dest="$HOME/$(basename "$f" | sed 's/_[0-9]\+$//')"
        [ -d "$dest" ] && { read -p "Timpa? (y/n): " ow; [ "$ow" != "y" ] && break; rm -rf "$dest"; }
        mv "$f" "$dest" &
        spinner $!
        echo -e "\033[1;32m[✔] Restore selesai: $dest\033[0m"
        break
    done
    pause
}

# ===== Main Menu =====
while true; do
    clear_screen
    echo -e "\033[1;34m=== MANAGER TERMUX (.in) ===\033[0m"
    echo "1. Kelola Home Termux (~)"
    echo "2. Kelola SDCard (/sdcard)"
    echo "X. Keluar"
    read -p $'\033[1;36mPilih menu: \033[0m' opt
    case "$opt" in
        1) home_manager ;;
        2) sdcard_manager ;;
        X|x) echo -e "\033[1;32mTerima kasih sudah menggunakan Manager Termux!\033[0m"; break ;;
    esac
done
